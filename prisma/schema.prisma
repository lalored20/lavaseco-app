generator client {
  provider   = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model memory_nodes {
  id         String                 @id
  name       String
  type       String?                @default("Concept")
  properties Json?                  @default("{}")
  created_at DateTime?              @default(now()) @db.Timestamptz(6)
  updated_at DateTime?              @default(now()) @db.Timestamptz(6)
  // embedding  Unsupported("vector")?
  importance Float?                 @default(1.0)
  metadata   Json?                  @default("{}")

  @@index([name], map: "idx_nodes_name")
  @@index([type], map: "idx_nodes_type")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model memory_relations {
  id           String    @id
  source       String
  relationship String
  target       String
  context      String?   @default("")
  confidence   Float?    @default(1.0)
  created_at   DateTime? @default(now()) @db.Timestamptz(6)

  @@index([relationship], map: "idx_relations_relationship")
  @@index([source], map: "idx_relations_source")
  @@index([target], map: "idx_relations_target")
}

// --- LAVASECO APP MODELS ---


enum Role {
  ADMIN
  STAFF
}

enum ShiftStatus {
  OPEN
  CLOSED
}

model User {
  id                String   @id @default(cuid())
  email             String   @unique
  name              String?  // Nombre del cajero/admin para mostrar en reportes
  passwordHash      String
  role              Role     @default(STAFF)
  
  isVerified        Boolean  @default(false)
  verificationCode  String?
  
  // Security & Rate Limiting
  verifAttempts     Int      @default(0)
  lastVerifSentAt   DateTime?
  lockoutUntil      DateTime?
  
  shifts            CashShift[] // Relación con los turnos
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model Client {
  id        String   @id @default(cuid())
  cedula    String?  @unique // Identificación oficial (opcional pero recomendada)
  name      String
  phone     String?
  address   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  orders    Order[]
}

model Expense {
  id          String   @id @default(uuid())
  description String
  amount      Float
  category    String?  // 'Alimentacion', 'Transporte', 'Suministros', etc.
  date        DateTime @default(now())
  
  // Who authorized it? (Optional)
  authorizedBy String? 
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Order {
  id            String   @id @default(uuid()) // UUID: Identificador único universal (OFFLINE COMPATIBLE)
  ticketNumber  Int      @default(autoincrement()) // Folio humano (Recibo #1045) - Solo informativo
  
  createdAt     DateTime @default(now())               
  scheduledDate DateTime?                              
  deliveredDate DateTime?                              
  
  status        String   @default("PENDIENTE")         
  location      String   @default("RECEPCION")         
  
  totalValue    Float    @default(0)
  paidAmount    Float    @default(0)
  paymentStatus String   @default("PENDIENTE")         
  
  clientId      String
  client        Client   @relation(fields: [clientId], references: [id])
  
  items         OrderItem[]
  payments      PaymentLog[]
}

model OrderItem {
  id          String  @id @default(cuid())
  orderId     String  // Relación por UUID
  order       Order   @relation(fields: [orderId], references: [id])
  
  quantity    Int     @default(1)
  type        String  
  color       String? 
  features    String? 
  
  defects     String? 
  notes       String? 
  
  price       Float   @default(0)
}

model PaymentLog {
  id          String   @id @default(cuid())
  orderId     String
  order       Order    @relation(fields: [orderId], references: [id])
  amount      Float
  type        String   @default("ABONO") // "ABONO" or "CANCELACION"
  createdAt   DateTime @default(now())
  note        String?
}

model CashShift {
  id              String   @id @default(uuid())
  date            DateTime @default(now())
  
  startTime       DateTime
  endTime         DateTime? // Puede ser nulo si está abierto
  
  status          ShiftStatus @default(OPEN)
  
  userId          String? // Usuario que abrió el turno (Opcional para compatibilidad con datos viejos)
  user            User?   @relation(fields: [userId], references: [id])
  
  turnNumber      Int      @default(1)
  
  cashCount       Float    @default(0)
  digitalCount    Float    @default(0)
  expenseCount    Float    @default(0)
  
  totalCalculated Float    @default(0)
  
  closedBy        String? // Nombre del que cerró, redundancies are OK for logs
  
  createdAt       DateTime @default(now())
}

model AllowedAdmin {
  id        String   @id @default(uuid())
  email     String   @unique
  addedBy   String?  // Correo de quien lo agregó
  createdAt DateTime @default(now())
}

model DailyGarmentCount {
  id         String   @id @default(uuid())
  date       DateTime @unique @default(now()) // Unique constraint ensures one entry per day (normalized)
  plantCount Int      @default(0)
  homeCount  Int      @default(0)
  plantNotes String?
  homeNotes  String?
  updatedAt  DateTime @updatedAt
}
